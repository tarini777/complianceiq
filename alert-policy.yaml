displayName: "ComplianceIQ Production Alerts"
documentation:
  content: "Alerting policy for ComplianceIQ production environment"
  mimeType: "text/markdown"
conditions:
  - displayName: "High Error Rate"
    conditionThreshold:
      filter: 'resource.type="cloud_run_revision" AND resource.labels.service_name="complianceiq" AND metric.type="run.googleapis.com/request_count" AND metric.labels.response_code_class!="2xx"'
      comparison: COMPARISON_GREATER_THAN
      thresholdValue: 10
      duration: 300s
      aggregations:
        - alignmentPeriod: 60s
          perSeriesAligner: ALIGN_RATE
          crossSeriesReducer: REDUCE_SUM
          groupByFields:
            - "metric.labels.response_code_class"
  - displayName: "High Response Time"
    conditionThreshold:
      filter: 'resource.type="cloud_run_revision" AND resource.labels.service_name="complianceiq" AND metric.type="run.googleapis.com/request_latencies"'
      comparison: COMPARISON_GREATER_THAN
      thresholdValue: 2000
      duration: 300s
      aggregations:
        - alignmentPeriod: 60s
          perSeriesAligner: ALIGN_MEAN
          crossSeriesReducer: REDUCE_MEAN
  - displayName: "High CPU Usage"
    conditionThreshold:
      filter: 'resource.type="cloudsql_database" AND resource.labels.database_id="complianceiq-prod:us-central1:complianceiq-db" AND metric.type="cloudsql.googleapis.com/database/cpu/utilization"'
      comparison: COMPARISON_GREATER_THAN
      thresholdValue: 0.8
      duration: 300s
      aggregations:
        - alignmentPeriod: 60s
          perSeriesAligner: ALIGN_MEAN
          crossSeriesReducer: REDUCE_MEAN
  - displayName: "High Memory Usage"
    conditionThreshold:
      filter: 'resource.type="cloudsql_database" AND resource.labels.database_id="complianceiq-prod:us-central1:complianceiq-db" AND metric.type="cloudsql.googleapis.com/database/memory/utilization"'
      comparison: COMPARISON_GREATER_THAN
      thresholdValue: 0.9
      duration: 300s
      aggregations:
        - alignmentPeriod: 60s
          perSeriesAligner: ALIGN_MEAN
          crossSeriesReducer: REDUCE_MEAN
  - displayName: "Service Down"
    conditionThreshold:
      filter: 'resource.type="cloud_run_revision" AND resource.labels.service_name="complianceiq" AND metric.type="run.googleapis.com/request_count"'
      comparison: COMPARISON_LESS_THAN
      thresholdValue: 1
      duration: 600s
      aggregations:
        - alignmentPeriod: 60s
          perSeriesAligner: ALIGN_RATE
          crossSeriesReducer: REDUCE_SUM
combiner: OR
enabled: true
notificationChannels:
  - "projects/complianceiq-prod/notificationChannels/EMAIL_CHANNEL_ID"
  - "projects/complianceiq-prod/notificationChannels/SLACK_CHANNEL_ID"
